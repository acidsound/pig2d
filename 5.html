<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />

    <title>sprite frame animation</title>

    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="libs/pig2d/css/core.css" />

    <!--제이쿼리가 종속성 관계에서 가장 높은 위치이다 그래서 맨먼저 쓴다-->
    <script src="libs/jquery.js"></script>

    <!--백본은 제이쿼리 다음에 포함시키는것이 건강에 이롭다 -->
    <script src="libs/backbone/underscore.js"></script>
    <script src="libs/backbone/json2.js"></script>
    <script src="libs/backbone/backbone.js"></script>


    <!--pig2d 엔진은 제이쿼리와 백본에 종속적이므로 맨 나중에 쓴다-->
    <script src="libs/pig2d/js/core.js"></script>
    <script src="libs/pig2d/js/node2d.js"></script>

    <script>


        $(function() {

            //var nodes = [];
            var rootNode;

            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: 'res/skeleton.json',
                success: function(data, textStatus, jqXHR) {

                    console.log(data);

                    rootNode = new Pig2d.node(
                            {
                                el : $('<div></div>'),
                                model : new Pig2d.model(),
                                name : 'sceneroot'
                            }
                    );
                    rootNode.get('model').setPosition(100,300);
                    $('.pig2d-fullscreen').append(rootNode.get('el'));
                    rootNode.show(true);


                    var x, y,rot;
                    var bone;

                    for(var index in data.bones)
                    {
                        bone = data.bones[index];

                        if(bone.x !=undefined) {
                            x = bone.x;
                        }
                        else
                        {
                            x = 0;
                        }

                        if(bone.y !=undefined) {
                            y = bone.y;
                        }
                        else
                        {
                            y = 0;
                        }

                        if(bone.rotation != undefined) {
                            rot = bone.rotation;
                        }
                        else {
                            rot = 0;
                        }

                        console.log(x + ',' + y);

                        //노드생성
                        var node = new Pig2d.node(
                                {
                                    el : $('.pig2d-templet #bone-templ').clone(),
                                    model : new Pig2d.model(),
                                    name : bone.name
                                }
                        );
                        rootNode.add(node,rootNode.findByName(bone.parent));
                        node.get('model').setPosition(x,y).setRotation(rot);
                        node.show(true);
                    }


                    //that.initElement($(data)[0]);

                },
                complete: function(jqXHR, textStatus) {

                    //전체 업데이트
//                    for(var index in nodes)  {
//                        nodes[index].update();
//                    }

                    console.log(rootNode);
                    rootNode.update(true);

                    //console.log(rootNode.findByName('bone3'))

                    //console.log('complete');
                    /*
                    if (complete != undefined) {
                        complete(textStatus, that);
                    }
                    */

                },
                error: function(qXHR, textStatus, errorThrown) {
                    console.log('error');

                }
            });




        });


    </script>


</head>

<body>

<div class="pig2d-fullscreen" >
</div>

<div class='pig2d-templet' style="visibility: hidden">
    <div id="bone-templ" style="
    background-color: blue;
    width:6px;

    -webkit-transform :translate(100px,100px)">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1"
             style="position: absolute;
         -webkit-transform :translate(6px,0px) rotate(180deg);"
                >
            <polygon points="0,0 6,100 6,0"
                     style="fill:red;"/>
            <line x1="0" y1="0" x2="6" y2="0"
                  style="stroke:rgb(255,255,0);stroke-width:1"/>
        </svg>

    </div>
</div>


</body>
</html>